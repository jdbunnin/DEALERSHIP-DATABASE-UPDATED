<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Inventory Intelligence</title>
    <style>
        :root{--primary:#1a1a2e;--secondary:#16213e;--accent:#0f3460;--highlight:#e94560;--success:#00b894;--warning:#fdcb6e;--danger:#e17055;--text:#dfe6e9;--text-muted:#b2bec3;--card-bg:#1e2a3a;--input-bg:#0d1b2a;--border:#2d3e50}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--primary);color:var(--text);min-height:100vh;line-height:1.6}
        ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:var(--primary)}::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px}

        .header{background:var(--secondary);border-bottom:2px solid var(--highlight);padding:20px 40px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
        .logo{display:flex;align-items:center;gap:15px}
        .logo-icon{width:48px;height:48px;background:linear-gradient(135deg,#e94560,#0f3460);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:bold;color:white}
        .logo h1{font-size:20px;font-weight:700}.logo span{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px}
        .header-actions{display:flex;gap:12px}
        .header-btn{padding:8px 20px;border:1px solid var(--border);background:0;color:var(--text);border-radius:8px;cursor:pointer;font-size:13px;transition:.3s}
        .header-btn:hover{border-color:var(--highlight);color:var(--highlight)}

        .main{max-width:1400px;margin:0 auto;padding:30px 40px}

        .form-section{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:30px}
        .form-card{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:28px;transition:.3s}
        .form-card:hover{border-color:var(--accent);box-shadow:0 8px 32px rgba(0,0,0,.3)}
        .form-card-header{display:flex;align-items:center;gap:12px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
        .form-card-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
        .icon-v{background:rgba(233,69,96,.15)}.icon-f{background:rgba(0,184,148,.15)}.icon-i{background:rgba(253,203,110,.15)}.icon-m{background:rgba(15,52,96,.3)}.icon-s{background:rgba(162,155,254,.15)}.icon-eye{background:rgba(116,185,255,.15)}
        .form-card-title{font-size:16px;font-weight:600}
        .form-card-sub{font-size:12px;color:var(--text-muted)}
        .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .form-group{display:flex;flex-direction:column;gap:6px}
        .form-group.full{grid-column:1/-1}
        .form-group label{font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
        .form-group input,.form-group select,.form-group textarea{padding:12px 16px;background:var(--input-bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;font-family:inherit;outline:0;transition:.3s}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--highlight);box-shadow:0 0 0 3px rgba(233,69,96,.1)}
        .form-group input::placeholder{color:#4a5568}
        .form-group textarea{resize:vertical;min-height:80px}
        .form-group select{cursor:pointer;appearance:none}

        .action-bar{display:flex;gap:16px;justify-content:center;margin:30px 0;flex-wrap:wrap}
        .btn{padding:16px 40px;border:0;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:.3s;font-family:inherit}
        .btn-primary{background:linear-gradient(135deg,#e94560,#0f3460);color:#fff;box-shadow:0 4px 20px rgba(233,69,96,.3)}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(233,69,96,.4)}
        .btn-secondary{background:0;color:var(--text);border:2px solid var(--border)}
        .btn-secondary:hover{border-color:var(--text-muted)}
        .btn-sample{background:rgba(0,184,148,.15);color:var(--success);border:1px solid rgba(0,184,148,.3)}
        .btn-sample:hover{background:rgba(0,184,148,.25)}
        .btn-sm{padding:10px 24px;font-size:14px}

        .loading{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(26,26,46,.95);z-index:1000;justify-content:center;align-items:center;flex-direction:column;gap:24px}
        .loading.active{display:flex}
        .spinner{width:60px;height:60px;border:4px solid var(--border);border-top-color:var(--highlight);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-text{font-size:18px;color:var(--text-muted)}

        .report{display:none;margin-top:20px}.report.active{display:block}
        .report-header{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:32px;margin-bottom:24px}
        .report-header h2{font-size:28px;font-weight:700;margin-bottom:8px}
        .report-meta{display:flex;gap:24px;flex-wrap:wrap}
        .meta-item{display:flex;flex-direction:column}
        .meta-label{font-size:11px;text-transform:uppercase;color:var(--text-muted);letter-spacing:1px}
        .meta-value{font-size:16px;font-weight:600}

        .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
        .kpi{background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:24px;text-align:center}
        .kpi-label{font-size:11px;text-transform:uppercase;color:var(--text-muted);letter-spacing:1px;margin-bottom:8px}
        .kpi-value{font-size:28px;font-weight:700}
        .kpi-detail{font-size:12px;color:var(--text-muted);margin-top:4px}
        .green{color:var(--success)}.yellow{color:var(--warning)}.red{color:var(--danger)}.blue{color:#74b9ff}

        .rcard{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;margin-bottom:24px;overflow:hidden}
        .rcard-head{padding:24px 28px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px}
        .rcard-num{width:36px;height:36px;background:linear-gradient(135deg,#e94560,#0f3460);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;color:white;flex-shrink:0}
        .rcard-title{font-size:18px;font-weight:700}
        .rcard-body{padding:28px}
        .rcard-body p{font-size:14px;line-height:1.7;color:var(--text-muted);margin-bottom:12px}
        .rcard-body strong{color:var(--text)}
        .rcard-body h3{font-size:16px;margin:20px 0 10px;color:var(--text)}

        .badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
        .badge-green{background:rgba(0,184,148,.15);color:var(--success)}
        .badge-yellow{background:rgba(253,203,110,.15);color:var(--warning)}
        .badge-red{background:rgba(233,69,96,.15);color:var(--highlight)}

        .rtable{width:100%;border-collapse:separate;border-spacing:0;margin:16px 0}
        .rtable thead th{background:var(--input-bg);padding:12px 16px;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);font-weight:600;border-bottom:2px solid var(--border)}
        .rtable tbody td{padding:12px 16px;border-bottom:1px solid var(--border);font-size:14px}

        .callout{padding:20px 24px;border-radius:12px;margin:16px 0;border-left:4px solid}
        .callout-red{background:rgba(233,69,96,.08);border-color:var(--highlight)}
        .callout-green{background:rgba(0,184,148,.08);border-color:var(--success)}
        .callout-blue{background:rgba(116,185,255,.08);border-color:#74b9ff}
        .callout-yellow{background:rgba(253,203,110,.08);border-color:var(--warning)}
        .callout h4{margin-bottom:8px;font-size:14px;text-transform:uppercase;letter-spacing:.5px}
        .callout p,.callout li{font-size:14px;line-height:1.7;color:var(--text-muted)}
        .callout ul{margin:8px 0 0 20px}

        .rec-box{background:var(--input-bg);border:2px solid var(--highlight);border-radius:12px;padding:24px;margin:20px 0;text-align:center}
        .rec-action{font-size:24px;font-weight:700;color:var(--highlight)}
        .rec-detail{font-size:16px;color:var(--text)}
        .rec-sub{font-size:13px;color:var(--text-muted);margin-top:8px}

        .action-item{background:var(--input-bg);border:1px solid var(--border);border-radius:12px;padding:20px 24px;margin:12px 0;display:flex;gap:16px;align-items:flex-start}
        .action-num{width:32px;height:32px;background:linear-gradient(135deg,#e94560,#0f3460);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0;color:white}
        .action-content h4{font-size:15px;font-weight:700;margin-bottom:6px}
        .action-content p{font-size:13px;color:var(--text-muted);line-height:1.6}
        .action-timing{display:inline-block;padding:2px 10px;background:rgba(233,69,96,.15);color:var(--highlight);border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}

        .prob-row{display:flex;align-items:center;gap:16px;margin:12px 0}
        .prob-label{width:100px;font-size:14px;font-weight:600;flex-shrink:0}
        .prob-bar-bg{flex:1;height:28px;background:var(--input-bg);border-radius:8px;overflow:hidden}
        .prob-bar{height:100%;border-radius:8px;display:flex;align-items:center;padding-left:12px;font-size:13px;font-weight:700;color:white;transition:width 1.5s ease}
        .prob-green{background:linear-gradient(90deg,#00b894,#00cec9)}
        .prob-yellow{background:linear-gradient(90deg,#fdcb6e,#f39c12)}
        .prob-red{background:linear-gradient(90deg,#e94560,#ff6b6b)}

        .exit-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:16px 0}
        .exit-card{background:var(--input-bg);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center}
        .exit-card.rec{border-color:var(--success);box-shadow:0 0 20px rgba(0,184,148,.15)}
        .exit-card h4{font-size:14px;margin-bottom:12px;text-transform:uppercase;letter-spacing:1px}
        .exit-card .exit-gross{font-size:24px;font-weight:700;margin-bottom:4px}
        .exit-card .exit-time{font-size:13px;color:var(--text-muted)}
        .rec-label{display:inline-block;background:var(--success);color:white;padding:2px 10px;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;margin-bottom:8px}

        .conf-bar{flex:1;height:8px;background:var(--input-bg);border-radius:4px;overflow:hidden}
        .conf-fill{height:100%;border-radius:4px;transition:width 1s}

        /* Daily Probability Chart */
        .chart-container{position:relative;background:var(--input-bg);border:1px solid var(--border);border-radius:12px;padding:20px;margin:20px 0;overflow:hidden}
        .chart-title{font-size:14px;font-weight:600;margin-bottom:16px;color:var(--text)}
        .chart-svg{width:100%;height:200px}
        .chart-tooltip{position:absolute;background:var(--secondary);border:1px solid var(--highlight);border-radius:8px;padding:10px 14px;font-size:12px;pointer-events:none;z-index:10;display:none;color:var(--text);white-space:nowrap}
        .chart-tooltip strong{color:var(--highlight)}

        .timestamp{text-align:center;padding:20px;font-size:12px;color:var(--text-muted);border-top:1px solid var(--border);margin-top:40px}

        @media(max-width:1024px){.form-section{grid-template-columns:1fr}.kpis{grid-template-columns:1fr 1fr}}
        @media(max-width:768px){.header{padding:16px 20px;flex-direction:column;gap:12px}.main{padding:20px 16px}.form-grid{grid-template-columns:1fr}.kpis{grid-template-columns:1fr}.exit-grid{grid-template-columns:1fr}}
        @media print{.header,.action-bar,.report-actions-bar{display:none!important}body{background:#fff;color:#000}.rcard,.kpi,.report-header{border-color:#ddd;background:#fff}.rcard-body p,.callout p,.callout li,.action-content p{color:#333}}
    </style>
</head>
<body>

<div class="header">
    <div class="logo">
        <div class="logo-icon">VI</div>
        <div>
            <h1>Vehicle Inventory Intelligence</h1>
            <span>Dealership Analytics Platform v2.0</span>
        </div>
    </div>
    <div class="header-actions">
        <button class="header-btn" onclick="showForm()">New Analysis</button>
        <button class="header-btn" onclick="window.print()">Print Report</button>
    </div>
</div>

<div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Generating Intelligence Report...</div>
</div>

<div class="main">
    <!-- FORM -->
    <div id="formContainer">
        <div class="action-bar" style="margin-top:0">
            <button class="btn btn-sample btn-sm" onclick="loadSample()">‚ñ∂ Load Sample (2021 Camry SE)</button>
            <button class="btn btn-secondary btn-sm" onclick="clearForm()">‚úï Clear</button>
        </div>

        <div class="form-section">
            <!-- Vehicle Details -->
            <div class="form-card">
                <div class="form-card-header">
                    <div class="form-card-icon icon-v">üöó</div>
                    <div><div class="form-card-title">Vehicle Details</div><div class="form-card-sub">Year, make, model, specs</div></div>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label>Year</label><input type="number" id="year" placeholder="2021"></div>
                    <div class="form-group"><label>Make</label><input type="text" id="make" placeholder="Toyota"></div>
                    <div class="form-group"><label>Model</label><input type="text" id="model" placeholder="Camry"></div>
                    <div class="form-group"><label>Trim</label><input type="text" id="trim" placeholder="SE"></div>
                    <div class="form-group"><label>Mileage</label><input type="number" id="mileage" placeholder="41850"></div>
                    <div class="form-group"><label>Ext Color</label><input type="text" id="extColor" placeholder="White"></div>
                    <div class="form-group"><label>Int Color</label><input type="text" id="intColor" placeholder="Black"></div>
                    <div class="form-group"><label>VIN</label><input type="text" id="vin" placeholder="Optional"></div>
                    <div class="form-group full"><label>Equipment / Packages</label><textarea id="equipment" placeholder="SE Convenience Package, BSM, Power Seat, CarPlay"></textarea></div>
                </div>
            </div>

            <!-- Financial -->
            <div class="form-card">
                <div class="form-card-header">
                    <div class="form-card-icon icon-f">üí∞</div>
                    <div><div class="form-card-title">Financial Data</div><div class="form-card-sub">Costs, pricing, margins</div></div>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label>Acquisition Cost</label><input type="number" id="acqCost" placeholder="19400"></div>
                    <div class="form-group"><label>Recon Cost</label><input type="number" id="reconCost" placeholder="850"></div>
                    <div class="form-group"><label>List Price</label><input type="number" id="listPrice" placeholder="23495"></div>
                    <div class="form-group"><label>Floorplan Rate %</label><input type="number" id="fpRate" placeholder="7.25" step="0.25"></div>
                    <div class="form-group"><label>Wholesale Price</label><input type="number" id="wsPrice" placeholder="20300"></div>
                    <div class="form-group"><label>Min Gross Target</label><input type="number" id="minGross" placeholder="2000"></div>
                </div>
            </div>

            <!-- Inventory Status -->
            <div class="form-card">
                <div class="form-card-header">
                    <div class="form-card-icon icon-i">üìä</div>
                    <div><div class="form-card-title">Inventory Status</div><div class="form-card-sub">Age, price history</div></div>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label>Days in Inventory</label><input type="number" id="daysInv" placeholder="52"></div>
                    <div class="form-group"><label>Price Changes</label><input type="number" id="priceChanges" placeholder="1"></div>
                    <div class="form-group full"><label>Days Since Last Change</label><input type="number" id="daysSinceChange" placeholder="18"></div>
                </div>
            </div>

            <!-- Market -->
            <div class="form-card">
                <div class="form-card-header">
                    <div class="form-card-icon icon-m">üåê</div>
                    <div><div class="form-card-title">Market Context</div><div class="form-card-sub">Competition, demand</div></div>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label>Comp Low</label><input type="number" id="compLow" placeholder="22300"></div>
                    <div class="form-group"><label>Comp High</label><input type="number" id="compHigh" placeholder="23900"></div>
                    <div class="form-group"><label>Competing Units</label><input type="number" id="compUnits" placeholder="17"></div>
                    <div class="form-group"><label>Regional Demand</label>
                        <select id="demand"><option value="">Select...</option><option value="high">High</option><option value="moderate">Moderate</option><option value="soft">Soft</option></select>
                    </div>
                    <div class="form-group full"><label>Seasonal Notes</label><textarea id="seasonal" placeholder="Market timing factors..."></textarea></div>
                </div>
            </div>

            <!-- Signals -->
            <div class="form-card" style="grid-column:1/-1">
                <div class="form-card-header">
                    <div class="form-card-icon icon-s">üì°</div>
                    <div><div class="form-card-title">Dealer Activity Signals</div><div class="form-card-sub">Engagement & feedback</div></div>
                </div>
                <div class="form-grid" style="grid-template-columns:repeat(3,1fr)">
                    <div class="form-group"><label>Views (7d)</label><input type="number" id="v7" placeholder="28"></div>
                    <div class="form-group"><label>Views (30d)</label><input type="number" id="v30" placeholder="134"></div>
                    <div class="form-group"><label>Leads (7d)</label><input type="number" id="l7" placeholder="3"></div>
                    <div class="form-group"><label>Leads (30d)</label><input type="number" id="l30" placeholder="11"></div>
                    <div class="form-group"><label>Test Drives (7d)</label><input type="number" id="td7" placeholder="1"></div>
                    <div class="form-group"><label>Test Drives (30d)</label><input type="number" id="td30" placeholder="4"></div>
                    <div class="form-group full"><label>Sales Notes / Objections</label><textarea id="salesNotes" placeholder="Customer feedback, objections..."></textarea></div>
                </div>
            </div>
        </div>

        <div class="action-bar">
            <button class="btn btn-primary" onclick="generateReport()">‚ö° Generate Intelligence Report</button>
            <button class="btn btn-secondary" onclick="clearForm()">Clear All</button>
        </div>
    </div>

    <!-- REPORT OUTPUT -->
    <div class="report" id="reportSection"></div>
</div>

<script>
function gv(id){return document.getElementById(id).value.trim()}
function gn(id){return parseFloat(document.getElementById(id).value)||0}
function fm(n){return n<0?'-$'+Math.abs(Math.round(n)).toLocaleString():'$'+Math.round(n).toLocaleString()}

function loadSample(){
    document.getElementById('year').value='2021';
    document.getElementById('make').value='Toyota';
    document.getElementById('model').value='Camry';
    document.getElementById('trim').value='SE';
    document.getElementById('mileage').value='41850';
    document.getElementById('extColor').value='White';
    document.getElementById('intColor').value='Black';
    document.getElementById('equipment').value='SE Convenience Package, Blind Spot Monitor, Power Driver Seat, Apple CarPlay';
    document.getElementById('acqCost').value='19400';
    document.getElementById('reconCost').value='850';
    document.getElementById('listPrice').value='23495';
    document.getElementById('fpRate').value='7.25';
    document.getElementById('wsPrice').value='20300';
    document.getElementById('minGross').value='2000';
    document.getElementById('daysInv').value='52';
    document.getElementById('priceChanges').value='1';
    document.getElementById('daysSinceChange').value='18';
    document.getElementById('compLow').value='22300';
    document.getElementById('compHigh').value='23900';
    document.getElementById('compUnits').value='17';
    document.getElementById('demand').value='moderate';
    document.getElementById('seasonal').value='Neutral; steady year-round demand, mild compression from newer model incentives';
    document.getElementById('v7').value='28';
    document.getElementById('v30').value='134';
    document.getElementById('l7').value='3';
    document.getElementById('l30').value='11';
    document.getElementById('td7').value='1';
    document.getElementById('td30').value='4';
    document.getElementById('salesNotes').value='Price resistance versus newer 2023 models; customers asking for $500-$1,000 flexibility';
}

function clearForm(){
    document.querySelectorAll('#formContainer input,#formContainer textarea,#formContainer select').forEach(function(e){
        if(e.tagName==='SELECT') e.selectedIndex=0; else e.value='';
    });
    document.getElementById('reportSection').innerHTML='';
    document.getElementById('reportSection').classList.remove('active');
}

function showForm(){
    document.getElementById('formContainer').style.display='block';
    document.getElementById('reportSection').classList.remove('active');
    window.scrollTo({top:0,behavior:'smooth'});
}

async function generateReport(){
    var data={
        year:gn('year'),make:gv('make'),model:gv('model'),trim:gv('trim'),mileage:gn('mileage'),
        ext_color:gv('extColor'),int_color:gv('intColor'),vin:gv('vin'),equipment:gv('equipment'),
        acquisition_cost:gn('acqCost'),recon_cost:gn('reconCost'),list_price:gn('listPrice'),
        floorplan_rate:gn('fpRate')||7.25,wholesale_price:gn('wsPrice'),min_gross:gn('minGross')||2000,
        days_in_inventory:gn('daysInv'),price_changes:gn('priceChanges'),days_since_price_change:gn('daysSinceChange'),
        comp_low:gn('compLow'),comp_high:gn('compHigh'),competing_units:gn('compUnits'),
        demand_signal:gv('demand')||'moderate',seasonal_notes:gv('seasonal'),
        views_7:gn('v7'),views_30:gn('v30'),leads_7:gn('l7'),leads_30:gn('l30'),
        test_drives_7:gn('td7'),test_drives_30:gn('td30'),sales_notes:gv('salesNotes')
    };

    if(!data.year||!data.make||!data.model||!data.acquisition_cost||!data.list_price){
        alert('Please fill in Year, Make, Model, Acquisition Cost, and List Price.');
        return;
    }

    document.getElementById('loading').classList.add('active');
    document.getElementById('loadingText').textContent='Generating Intelligence Report...';

    try{
        var resp=await fetch('/api/analyze',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(data)
        });
        var result=await resp.json();
        if(!resp.ok) throw new Error(result.error||'Analysis failed');

        renderReport(data,result.report.analysis);
        document.getElementById('formContainer').style.display='none';
        document.getElementById('reportSection').classList.add('active');
        window.scrollTo({top:0,behavior:'smooth'});
    }catch(err){
        alert('Error: '+err.message);
    }finally{
        document.getElementById('loading').classList.remove('active');
    }
}

function renderReport(d,a){
    var title=d.year+' '+d.make+' '+d.model+' '+(d.trim||'');
    var f=a.financials;
    var p=a.pricing;
    var sp=a.sale_probability;
    var ag=a.aging;
    var ep=a.exit_path;
    var rc=a.risk_and_confidence;

    var zoneBadge=ag.zone==='HEALTHY'?'badge-green':ag.zone==='AT-RISK'?'badge-yellow':'badge-red';
    var grossColor=f.current_net_gross>2000?'green':f.current_net_gross>0?'yellow':'red';

    // Build daily curve chart SVG
    var curveHtml='';
    if(sp.daily_curve&&sp.daily_curve.length>0){
        var cw=800,ch=180,padL=45,padR=15,padT=10,padB=30;
        var plotW=cw-padL-padR,plotH=ch-padT-padB;
        var maxCum=Math.max.apply(null,sp.daily_curve.map(function(p){return p.cumulative_probability}))||100;
        maxCum=Math.ceil(maxCum/10)*10;

        var cumPoints='';
        var dailyBars='';
        var maxDaily=Math.max.apply(null,sp.daily_curve.map(function(p){return p.daily_probability}))||5;

        for(var i=0;i<sp.daily_curve.length;i++){
            var pt=sp.daily_curve[i];
            var x=padL+(pt.day/90)*plotW;
            var yCum=padT+plotH-(pt.cumulative_probability/maxCum)*plotH;
            cumPoints+=(i===0?'M':'L')+x.toFixed(1)+','+yCum.toFixed(1)+' ';

            var barH=(pt.daily_probability/maxDaily)*plotH*0.6;
            var barY=padT+plotH-barH;
            var barColor=pt.day<=30?'rgba(0,184,148,0.4)':pt.day<=60?'rgba(253,203,110,0.4)':'rgba(233,69,96,0.4)';
            dailyBars+='<rect x="'+(x-2)+'" y="'+barY+'" width="4" height="'+barH+'" fill="'+barColor+'" data-day="'+pt.day+'" data-daily="'+pt.daily_probability+'" data-cum="'+pt.cumulative_probability+'"/>';
        }

        // Grid lines
        var gridLines='';
        for(var g=0;g<=maxCum;g+=20){
            var gy=padT+plotH-(g/maxCum)*plotH;
            gridLines+='<line x1="'+padL+'" y1="'+gy+'" x2="'+(cw-padR)+'" y2="'+gy+'" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>';
            gridLines+='<text x="'+(padL-8)+'" y="'+(gy+4)+'" fill="#b2bec3" font-size="10" text-anchor="end">'+g+'%</text>';
        }

        // Day markers
        var dayMarkers='';
        for(var dm=0;dm<=90;dm+=15){
            var dx=padL+(dm/90)*plotW;
            dayMarkers+='<text x="'+dx+'" y="'+(ch-5)+'" fill="#b2bec3" font-size="10" text-anchor="middle">'+dm+'</text>';
            if(dm>0) dayMarkers+='<line x1="'+dx+'" y1="'+padT+'" x2="'+dx+'" y2="'+(padT+plotH)+'" stroke="rgba(255,255,255,0.04)" stroke-width="1"/>';
        }

        // Day 30/60 markers
        var d30x=padL+(30/90)*plotW;
        var d60x=padL+(60/90)*plotW;
        var markers='<line x1="'+d30x+'" y1="'+padT+'" x2="'+d30x+'" y2="'+(padT+plotH)+'" stroke="rgba(0,184,148,0.3)" stroke-width="1" stroke-dasharray="4,4"/>';
        markers+='<text x="'+d30x+'" y="'+(padT-2)+'" fill="#00b894" font-size="9" text-anchor="middle">30d</text>';
        markers+='<line x1="'+d60x+'" y1="'+padT+'" x2="'+d60x+'" y2="'+(padT+plotH)+'" stroke="rgba(253,203,110,0.3)" stroke-width="1" stroke-dasharray="4,4"/>';
        markers+='<text x="'+d60x+'" y="'+(padT-2)+'" fill="#fdcb6e" font-size="9" text-anchor="middle">60d</text>';

        curveHtml='<div class="chart-container" id="chartContainer">'
            +'<div class="chart-title">Daily Probability Curve ‚Äî Hover for Details</div>'
            +'<div class="chart-tooltip" id="chartTooltip"></div>'
            +'<svg class="chart-svg" viewBox="0 0 '+cw+' '+ch+'" preserveAspectRatio="xMidYMid meet">'
            +gridLines+dayMarkers+markers+dailyBars
            +'<path d="'+cumPoints+'" fill="none" stroke="#e94560" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>'
            +'</svg>'
            +'<div style="display:flex;gap:20px;margin-top:8px;font-size:11px;color:var(--text-muted)">'
            +'<span>üü¢ Bars = Daily sell probability</span>'
            +'<span>üî¥ Line = Cumulative probability</span>'
            +'</div></div>';
    }

    // Curve insights
    var insightsHtml='';
    if(sp.curve_insights){
        var ci=sp.curve_insights;
        insightsHtml='<div class="callout callout-blue"><h4>Probability Curve Insights</h4><ul>'
            +'<li><strong>Acceleration:</strong> '+ci.acceleration_phase+'</li>'
            +'<li><strong>Peak Day:</strong> Day '+ci.peak_probability_day+' ‚Äî highest daily sell probability.</li>'
            +'<li><strong>Decay Begins:</strong> '+ci.decay_begins+'</li>'
            +'<li><strong>Critical Window:</strong> '+ci.critical_insight+'</li>'
            +'</ul></div>';
    }

    var html=''
        +'<div class="report-actions-bar" style="display:flex;gap:12px;justify-content:flex-end;margin-bottom:20px">'
        +'<button class="btn btn-secondary btn-sm" onclick="showForm();document.getElementById(\'formContainer\').style.display=\'block\'">‚Üê Back</button>'
        +'<button class="btn btn-secondary btn-sm" onclick="window.print()">üñ® Print</button>'
        +'</div>'

        // Header
        +'<div class="report-header">'
        +'<h2>'+title+'</h2>'
        +'<div class="report-meta">'
        +'<div class="meta-item"><span class="meta-label">Mileage</span><span class="meta-value">'+d.mileage.toLocaleString()+' mi</span></div>'
        +'<div class="meta-item"><span class="meta-label">Color</span><span class="meta-value">'+d.ext_color+' / '+d.int_color+'</span></div>'
        +'<div class="meta-item"><span class="meta-label">Days in Stock</span><span class="meta-value">'+d.days_in_inventory+'</span></div>'
        +'<div class="meta-item"><span class="meta-label">Zone</span><span class="badge '+zoneBadge+'">'+ag.zone+'</span></div>'
        +'</div></div>'

        // KPIs
        +'<div class="kpis">'
        +'<div class="kpi"><div class="kpi-label">Total Invested</div><div class="kpi-value blue">'+fm(f.total_invested)+'</div><div class="kpi-detail">Acq + Recon</div></div>'
        +'<div class="kpi"><div class="kpi-label">Net Gross</div><div class="kpi-value '+grossColor+'">'+fm(f.current_net_gross)+'</div><div class="kpi-detail">After '+fm(f.floorplan_accrued_to_date)+' floorplan</div></div>'
        +'<div class="kpi"><div class="kpi-label">Daily Floorplan</div><div class="kpi-value red">$'+f.daily_floorplan_cost.toFixed(2)+'</div><div class="kpi-detail">'+fm(f.floorplan_accrued_to_date)+' accrued</div></div>'
        +'<div class="kpi"><div class="kpi-label">Wholesale Exit</div><div class="kpi-value '+(f.wholesale_net_today>=0?'yellow':'red')+'">'+fm(f.wholesale_net_today)+'</div><div class="kpi-detail">Net today</div></div>'
        +'</div>'

        // 1. Sale Probability
        +'<div class="rcard"><div class="rcard-head"><div class="rcard-num">1</div><div class="rcard-title">Multi-Horizon Sale Probability</div></div>'
        +'<div class="rcard-body">'
        +'<div class="prob-row"><div class="prob-label">30 Days</div><div class="prob-bar-bg"><div class="prob-bar '+(sp.prob_30_day>50?'prob-green':sp.prob_30_day>30?'prob-yellow':'prob-red')+'" style="width:'+sp.prob_30_day+'%">'+sp.prob_30_day+'%</div></div></div>'
        +'<div class="prob-row"><div class="prob-label">60 Days</div><div class="prob-bar-bg"><div class="prob-bar '+(sp.prob_60_day>60?'prob-green':sp.prob_60_day>40?'prob-yellow':'prob-red')+'" style="width:'+sp.prob_60_day+'%">'+sp.prob_60_day+'%</div></div></div>'
        +'<div class="prob-row"><div class="prob-label">90 Days</div><div class="prob-bar-bg"><div class="prob-bar '+(sp.prob_90_day>70?'prob-green':sp.prob_90_day>50?'prob-yellow':'prob-red')+'" style="width:'+sp.prob_90_day+'%">'+sp.prob_90_day+'%</div></div></div>'
        +curveHtml
        +insightsHtml
        +'<div class="callout callout-blue"><h4>Key Drivers</h4><ul>'
        +sp.factors_30.concat(sp.factors_60).concat(sp.factors_90).map(function(f){return '<li>'+f+'</li>'}).join('')
        +'</ul></div>'
        +'</div></div>'

        // 2. Aging
        +'<div class="rcard"><div class="rcard-head"><div class="rcard-num">2</div><div class="rcard-title">Inventory Velocity & Aging Risk</div></div>'
        +'<div class="rcard-body">'
        +'<p>Aging Zone: <span class="badge '+zoneBadge+'">'+ag.zone+'</span> ‚Äî '+ag.zone_detail+'</p>'
        +'<table class="rtable"><thead><tr><th>Scenario</th><th>+Days</th><th>Total</th><th>Floorplan</th><th>Gross (Sticker)</th><th>Realistic Gross</th></tr></thead><tbody>'
        +ag.erosion_table.map(function(r,i){
            return '<tr><td>'+(i===0?'<strong>Today</strong>':'+'+r.additional_days+'d')+'</td><td>'+r.additional_days+'</td><td>'+r.total_days+'</td><td>'+fm(r.floorplan_accrued)+'</td><td>'+fm(r.gross_at_sticker)+'</td><td>'+fm(r.realistic_gross_low)+' ‚Äì '+fm(r.realistic_gross_high)+'</td></tr>';
        }).join('')
        +'</tbody></table>'
        +'<div class="callout callout-red"><h4>Irrationality Threshold: Day '+ag.irrationality_threshold.day+'</h4><p>'+ag.irrationality_threshold.explanation+'</p></div>'
        +'</div></div>'

        // 3. Pricing
        +'<div class="rcard"><div class="rcard-head"><div class="rcard-num">3</div><div class="rcard-title">Pricing Strategy</div></div>'
        +'<div class="rcard-body">'
        +'<div class="rec-box">'
        +'<div class="rec-action">'+(p.action==='REDUCE'?'‚Üì REDUCE BY '+fm(p.change_amount):p.action==='INCREASE'?'‚Üë INCREASE BY '+fm(p.change_amount):'‚óè HOLD PRICE')+'</div>'
        +'<div class="rec-detail">'+(p.action!=='HOLD'?'New Price: <strong>'+fm(p.new_list_price)+'</strong> (from '+fm(p.current_list_price)+')':'Maintain at <strong>'+fm(p.current_list_price)+'</strong>')+'</div>'
        +'<div class="rec-sub">'+p.timing+'</div>'
        +'</div>'
        +'<p>'+p.reasoning+'</p>'
        +'<div class="callout callout-blue"><h4>Elasticity: '+p.elasticity.level+'</h4><p>'+p.elasticity.detail+'</p></div>'
        +(p.probability_impact?'<div class="callout callout-green"><h4>Expected Impact</h4><p>'+p.probability_impact.explanation+'</p></div>':'')
        +'<h3>Expected Outcome</h3>'
        +'<p>Transaction: <strong>'+fm(p.expected_transaction_range.low)+' ‚Äì '+fm(p.expected_transaction_range.high)+'</strong></p>'
        +'<p>Gross: <strong>'+fm(p.expected_gross_range.low)+' ‚Äì '+fm(p.expected_gross_range.high)+'</strong></p>'
        +'</div></div>'

        // 4. Exit Path
        +'<div class="rcard"><div class="rcard-head"><div class="rcard-num">4</div><div class="rcard-title">Optimal Exit Path</div></div>'
        +'<div class="rcard-body">'
        +'<div class="exit-grid">'
        +ep.paths.map(function(path){
            return '<div class="exit-card '+(path.recommended?'rec':'')+'">'
                +(path.recommended?'<div class="rec-label">RECOMMENDED</div>':'')
                +'<h4>'+path.path.replace('_',' ')+'</h4>'
                +'<div class="exit-gross '+(path.recommended?'green':'')+'">'+fm(path.expected_gross_low)+(path.expected_gross_high!==path.expected_gross_low?' ‚Äì '+fm(path.expected_gross_high):'')+'</div>'
                +'<div class="exit-time">'+path.expected_days+'</div>'
                +'<div style="font-size:12px;color:var(--text-muted);margin-top:8px">'+path.probability+'</div>'
                +'</div>';
        }).join('')
        +'</div>'
        +'<p>'+ep.reasoning+'</p>'
        +'<div class="callout callout-yellow"><h4>Decision Trigger</h4><p>'+ep.decision_trigger.condition+'</p></div>'
        +'</div></div>'

        // 5. Action Plan
        +'<div class="rcard"><div class="rcard-head"><div class="rcard-num">5</div><div class="rcard-title">Dealer Action Plan ‚Äî This Week</div></div>'
        +'<div class="rcard-body">'
        +a.action_plan.map(function(act){
            return '<div class="action-item">'
                +'<div class="action-num">'+act.priority+'</div>'
                +'<div class="action-content">'
                +'<div class="action-timing">'+act.timing+'</div>'
                +'<h4>'+act.title+'</h4>'
                +'<p>'+act.detail+'</p>'
                +'<p style="margin-top:6px;font-style:italic"><strong>Purpose:</strong> '+act.purpose+'</p>'
                +'</div></div>';
        }).join('')
        +'</div></div>'

        // 6. Risk
        +'<div class="rcard"><div class="rcard-head"><div class="rcard-num">6</div><div class="rcard-title">Risk & Confidence</div></div>'
        +'<div class="rcard-body">'
        +'<h3>Risk Factors</h3>'
        +rc.risks.map(function(r){
            return '<div class="callout '+(r.severity==='HIGH'?'callout-red':r.severity==='MEDIUM'?'callout-yellow':'callout-blue')+'">'
                +'<h4>'+r.factor+' <span class="badge '+(r.severity==='HIGH'?'badge-red':r.severity==='MEDIUM'?'badge-yellow':'badge-green')+'">'+r.severity+'</span></h4>'
                +'<p>'+r.detail+'</p></div>';
        }).join('')
        +'<h3>Confidence: '+rc.confidence.level+'</h3>'
        +'<div style="display:flex;align-items:center;gap:12px;margin:16px 0">'
        +'<div class="conf-bar"><div class="conf-fill" style="width:'+rc.confidence.percent+'%;background:'+(rc.confidence.level==='HIGH'?'var(--success)':rc.confidence.level==='MEDIUM'?'var(--warning)':'var(--danger)')+'"></div></div>'
        +'<span style="font-weight:700">'+rc.confidence.percent+'%</span>'
        +'</div>'
        +'<p>Data completeness: '+rc.confidence.data_completeness+'%</p>'
        +'</div></div>'

        +'<div class="timestamp">Analysis generated '+new Date().toLocaleString()+' ‚Äî Vehicle Inventory Intelligence v2.0</div>';

    document.getElementById('reportSection').innerHTML=html;

    // Attach chart hover events
    setTimeout(function(){
        var container=document.getElementById('chartContainer');
        var tooltip=document.getElementById('chartTooltip');
        if(container&&tooltip){
            var bars=container.querySelectorAll('rect[data-day]');
            bars.forEach(function(bar){
                bar.style.cursor='crosshair';
                bar.addEventListener('mouseenter',function(e){
                    var day=bar.getAttribute('data-day');
                    var daily=bar.getAttribute('data-daily');
                    var cum=bar.getAttribute('data-cum');
                    tooltip.innerHTML='<strong>Day '+day+'</strong><br>Daily: '+daily+'%<br>Cumulative: '+cum+'%';
                    tooltip.style.display='block';
                });
                bar.addEventListener('mousemove',function(e){
                    var rect=container.getBoundingClientRect();
                    tooltip.style.left=(e.clientX-rect.left+15)+'px';
                    tooltip.style.top=(e.clientY-rect.top-10)+'px';
                });
                bar.addEventListener('mouseleave',function(){
                    tooltip.style.display='none';
                });
            });
        }
    },100);
}
</script>
</body>
</html>
